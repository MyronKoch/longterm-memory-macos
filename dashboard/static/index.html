<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longterm Memory</title>
    
    <!-- Liquid Glass Design System -->
    <link rel="stylesheet" href="/static/liquid-glass.css">
    <link rel="stylesheet" href="/static/liquid-glass-components.css">
    <link rel="stylesheet" href="/static/utilities.css">
    
    <!-- Vue.js & Fuse.js (vendored locally for security) -->
    <script src="/static/vue.global.prod.js"></script>
    <script src="/static/fuse.min.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        
        /* App Layout */
        .app-container {
            min-height: 100vh;
            padding-top: 72px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }
        
        /* Memory Cards - Apple solid card style */
        .memory-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            cursor: pointer;
            transition: 
                transform var(--duration-base) var(--ease-default),
                background var(--duration-fast) var(--ease-default),
                box-shadow var(--duration-base) var(--ease-default);
        }
        
        .memory-card:hover {
            transform: translateY(-2px);
            background: var(--glass-bg-hover);
            box-shadow: var(--shadow-lg);
        }
        
        .memory-text {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: var(--leading-relaxed);
        }
        
        /* Importance indicator - small corner badge with tooltip */
        .importance-indicator {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            cursor: help;
        }
        
        .importance-indicator::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 16px;
            top: -4px;
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .importance-indicator:hover::after {
            opacity: 1;
        }
        
        /* Similarity Badge */
        .similarity-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            font-family: var(--font-mono);
            color: var(--brand-primary);
            background: var(--brand-primary-bg);
            border-radius: var(--radius-full);
        }
        
        /* Timeline */
        .timeline-container {
            overflow-x: auto;
            padding-bottom: var(--space-2);
        }
        
        .timeline-bars {
            display: flex;
            align-items: flex-end;
            height: 160px;
            min-width: max-content;
            gap: 2px;
        }
        
        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
            cursor: pointer;
        }
        
        .timeline-item:hover .timeline-bar-total {
            background: var(--accent-purple);
        }
        
        .timeline-item-selected .timeline-bar-total {
            background: var(--accent-purple) !important;
            box-shadow: 0 0 8px var(--accent-purple);
        }
        
        .timeline-item-selected .timeline-label {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .timeline-bar-total {
            width: 24px;
            background: var(--brand-primary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: background var(--duration-fast);
            min-height: 4px;
        }
        
        .timeline-bar-important {
            width: 24px;
            background: var(--color-warning);
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            min-height: 0;
        }
        
        .timeline-label {
            margin-top: var(--space-1);
            font-size: 10px;
            color: var(--text-quaternary);
            white-space: nowrap;
        }
        
        /* Detail Panel */
        .detail-panel-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: calc(var(--z-modal) - 1);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--duration-base) var(--ease-default);
        }
        
        .detail-panel-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .detail-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            max-width: 480px;
            background: var(--bg-elevated);
            border-left: 1px solid var(--glass-border);
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform var(--duration-slow) var(--ease-default);
        }
        
        .detail-panel.open {
            transform: translateX(0);
        }
        
        .detail-panel-header {
            position: sticky;
            top: 0;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--space-4) var(--space-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .detail-panel-body {
            padding: var(--space-5);
        }
        
        .detail-section {
            margin-bottom: var(--space-5);
        }
        
        .detail-label {
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: var(--space-1);
        }
        
        /* Logo Text */
        .logo-text {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Nav shrink on scroll */
        .nav-floating.scrolled {
            height: var(--nav-height-compact);
            padding: var(--space-1-5) var(--space-4);
        }
        
        .nav-floating.scrolled .logo-text {
            font-size: var(--text-base);
        }
        
        /* Stats Grid - Apple solid card style */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-4);
        }
        
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            transition: transform var(--duration-base) var(--ease-default);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: var(--text-sm);
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }
        
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Tag Pills */
        .tag-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1-5) var(--space-3);
            font-size: var(--text-sm);
            color: var(--text-secondary);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-default);
        }
        
        .tag-pill:hover {
            background: var(--glass-bg-hover);
            color: var(--text-primary);
        }
        
        .tag-pill.active {
            background: var(--brand-primary-bg);
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }
        
        /* Entity Badge */
        .entity-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            color: var(--accent-teal);
            background: rgba(100, 210, 255, 0.1);
            border-radius: var(--radius-sm);
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .page-btn {
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-default);
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--glass-bg-hover);
            color: var(--text-primary);
        }
        
        .page-btn.active {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: white;
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Insights - Apple solid card style */
        .insight-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }
        
        /* Insights Bento Grid */
        .insights-bento {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .insight-hero {
            grid-column: 1 / -1;  /* Full width */
        }
        
        .insight-large {
            grid-row: span 1;
        }
        
        @media (max-width: 768px) {
            .insights-bento { grid-template-columns: 1fr; }
        }
        
        /* Activity Chart */
        .activity-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 140px;
            padding-top: 20px;
        }
        
        .activity-day {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .activity-bar-wrapper {
            width: 100%;
            max-width: 48px;
            height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .activity-bar-fill {
            width: 70%;
            background: linear-gradient(180deg, var(--brand-primary) 0%, rgba(10, 132, 255, 0.6) 100%);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
        }
        
        .activity-day-label {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        .activity-day-count {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Focus Areas */
        .focus-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .focus-item {
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            border-radius: 12px;
            transition: background 0.15s;
        }
        
        .focus-item:hover {
            background: var(--bg-tertiary);
        }
        
        .focus-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--brand-primary);
            background: rgba(10, 132, 255, 0.15);
            border-radius: 8px;
        }
        
        .focus-info {
            flex: 1;
            min-width: 0;
        }
        
        .focus-tag {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .focus-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .focus-bar-fill {
            height: 100%;
            background: var(--brand-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .focus-count {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* Correlations */
        .correlation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .correlation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .correlation-item:last-child {
            border-bottom: none;
        }
        
        .correlation-tags {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .correlation-tag {
            color: rgba(10, 132, 255, 0.9);
            font-weight: 500;
            cursor: pointer;
            transition: color 0.15s;
        }
        
        .correlation-tag:hover {
            color: var(--brand-primary);
        }
        
        .correlation-arrow {
            color: var(--text-quaternary);
            font-size: 12px;
        }
        
        .correlation-count {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
        }
        
        /* Milestones */
        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .milestone-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 12px;
            margin: 0 -12px;
            border-radius: 12px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        
        .milestone-row:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--color-warning);
        }
        
        .milestone-date {
            font-size: 12px;
            color: var(--text-quaternary);
            font-weight: 500;
        }
        
        .milestone-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Generic solid card (Apple style) */
        .solid-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
        }
        
        /* Bento Grid - Apple 3-column style */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .bento-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 640px) {
            .bento-grid { grid-template-columns: 1fr; }
        }
        
        .tag-correlation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) 0;
        }
        
        .tag-link {
            color: rgba(10, 132, 255, 0.9);  /* Lighter blue for readability */
            cursor: pointer;
            font-weight: 500;
        }
        
        .tag-link:hover {
            color: var(--brand-primary);
            text-decoration: underline;
        }
        
        .milestone-item {
            border-left: 2px solid var(--color-warning);
            padding-left: var(--space-3);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: background 0.15s;
            padding: var(--space-2) var(--space-3);
            margin-left: calc(-1 * var(--space-3));
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }
        
        .milestone-item:hover {
            background: var(--glass-bg-hover);
        }
        
        .activity-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .activity-bar-fill {
            width: 100%;
            background: var(--brand-primary);
            border-radius: var(--radius-sm);
            min-height: 4px;
        }
    </style>
</head>
<body>
    <!-- Skip Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="app" v-cloak class="app-container">
        
        <!-- Floating Navigation -->
        <nav class="nav-floating" :class="{ scrolled: isScrolled }">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="color: var(--brand-primary)">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <circle cx="12" cy="12" r="4" fill="currentColor"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <span class="logo-text">Memory</span>
                </div>
                
                <!-- View Tabs -->
                <div class="tabs">
                    <button @click="currentView = 'browse'" :class="['tab', { active: currentView === 'browse' }]">Browse</button>
                    <button @click="currentView = 'timeline'" :class="['tab', { active: currentView === 'timeline' }]">Timeline</button>
                    <button @click="currentView = 'insights'" :class="['tab', { active: currentView === 'insights' }]">Insights</button>
                    <button @click="currentView = 'archive'" :class="['tab', { active: currentView === 'archive' }]">Archive</button>
                    <a href="/graph" class="tab">Graph</a>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Search Trigger -->
                <button @click="openCommandPalette" class="btn btn-secondary btn-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <span class="hidden sm:inline">Search</span>
                    <kbd class="hidden sm:inline ml-2 px-1.5 py-0.5 text-xs bg-black/20 rounded">‚åòK</kbd>
                </button>
                
                <!-- Theme Toggle -->
                <div class="flex items-center gap-1">
                    <button @click="setTheme('light')" :class="['btn btn-icon btn-sm', theme === 'light' ? 'bg-white/20' : 'btn-ghost']" aria-label="Light theme">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                    </button>
                    <button @click="setTheme('system')" :class="['btn btn-icon btn-sm', theme === 'system' ? 'bg-white/20' : 'btn-ghost']" aria-label="System theme">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                    </button>
                    <button @click="setTheme('dark')" :class="['btn btn-icon btn-sm', theme === 'dark' ? 'bg-white/20' : 'btn-ghost']" aria-label="Dark theme">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Command Palette -->
        <div v-if="showCommandPalette" class="modal-backdrop visible" @click.self="showCommandPalette = false">
            <div class="command-palette visible">
                <input ref="cmdInput" v-model="cmdQuery"
                    @keydown.escape="showCommandPalette = false"
                    @keydown.enter="executeCommand"
                    @keydown.up.prevent="cmdIndex = Math.max(0, cmdIndex - 1)"
                    @keydown.down.prevent="cmdIndex = Math.min(filteredCommands.length - 1, cmdIndex + 1)"
                    type="text" class="command-input" placeholder="Search memories, entities, or type a command...">
                <div class="command-results">
                    <div v-if="cmdQuery.length === 0">
                        <div class="px-5 py-2 text-caption text-tertiary">Quick Actions</div>
                        <div v-for="(cmd, i) in defaultCommands" :key="cmd.id" :class="['command-item', { selected: cmdIndex === i }]" @click="executeCommand(cmd)">
                            <div class="command-item-icon">{{ cmd.icon }}</div>
                            <div class="flex-1">
                                <div class="command-item-title">{{ cmd.name }}</div>
                                <div class="command-item-desc">{{ cmd.description }}</div>
                            </div>
                            <kbd v-if="cmd.shortcut" class="text-caption-sm text-muted px-2 py-1 bg-white/5 rounded">{{ cmd.shortcut }}</kbd>
                        </div>
                    </div>
                    <div v-else>
                        <div v-if="cmdLoading" class="empty-state py-8"><div class="text-tertiary">Searching...</div></div>
                        <div v-else-if="filteredCommands.length === 0" class="empty-state py-8"><div class="text-tertiary">No results found</div></div>
                        <div v-else>
                            <div v-for="(cmd, i) in filteredCommands" :key="cmd.id" :class="['command-item', { selected: cmdIndex === i }]" @click="executeCommand(cmd)">
                                <div class="command-item-icon">{{ cmd.icon }}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="command-item-title truncate">{{ cmd.name }}</div>
                                    <div class="command-item-desc truncate">{{ cmd.description }}</div>
                                </div>
                                <span v-if="cmd.similarity" class="similarity-badge">{{ (cmd.similarity * 100).toFixed(0) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-5 py-3 border-t border-white/10 flex gap-4 text-caption text-muted">
                    <span>‚Üë‚Üì Navigate</span><span>‚Üµ Select</span><span>esc Close</span>
                </div>
            </div>
        </div>

        <!-- Detail Panel Backdrop (click to close) -->
        <div :class="['detail-panel-backdrop', { open: selectedObservation }]" @click="selectedObservation = null"></div>
        
        <!-- Detail Side Panel -->
        <div :class="['detail-panel', { open: selectedObservation }]">
            <div class="detail-panel-header">
                <span class="text-subhead">Observation #{{ selectedObservation?.id }}</span>
                <button @click="selectedObservation = null" class="btn btn-icon btn-ghost btn-sm">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="detail-panel-body" v-if="selectedObservation">
                <div class="detail-section">
                    <div class="detail-label">Entity</div>
                    <div class="text-body">{{ selectedObservation.entity_name || 'Unknown' }}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Type</div>
                    <span class="badge badge-glass">{{ selectedObservation.observation_type || 'note' }}</span>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Content</div>
                    <div class="memory-text text-body-sm text-secondary">{{ selectedObservation.observation_text }}</div>
                </div>
                <div class="detail-section" v-if="selectedObservation.tags?.length">
                    <div class="detail-label">Tags</div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="tag in selectedObservation.tags" :key="tag" class="badge badge-glass">{{ tag }}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 detail-section">
                    <div>
                        <div class="detail-label">Importance</div>
                        <div class="text-lg font-semibold" style="color: var(--color-warning)">{{ ((selectedObservation.importance || 0) * 100).toFixed(0) }}%</div>
                    </div>
                    <div>
                        <div class="detail-label">Created</div>
                        <div class="text-body-sm text-secondary">{{ formatDate(selectedObservation.created_at) }}</div>
                    </div>
                </div>
                <button @click="findSimilar(selectedObservation.id)" class="btn btn-secondary w-full mt-4">
                    üß† Find Similar Observations
                </button>
                <button @click="deleteObservation(selectedObservation.id)" class="btn btn-ghost w-full mt-2" style="color: #FF453A;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                    Delete Memory
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="main-content">
            
            <!-- Stats Row -->
            <div class="stats-grid mb-8">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.observations?.toLocaleString() || '0' }}</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.archived?.toLocaleString() || '0' }}</div>
                    <div class="stat-label">Archived</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.entities?.toLocaleString() || '0' }}</div>
                    <div class="stat-label">Entities</div>
                </div>
                <div class="stat-card stat-card-accent">
                    <div class="stat-value text-brand">{{ stats.embedded?.toLocaleString() || '0' }}</div>
                    <div class="stat-label">Embedded</div>
                </div>
                <div class="stat-card stat-card-warning">
                    <div class="stat-value" style="color: var(--color-warning)">{{ stats.high_importance?.toLocaleString() || '0' }}</div>
                    <div class="stat-label">High Priority</div>
                </div>
                <div class="stat-card stat-card-success">
                    <div class="stat-value" style="color: var(--color-success)">{{ embeddingPercent }}%</div>
                    <div class="stat-label">Coverage</div>
                </div>
            </div>

            <!-- BROWSE VIEW -->
            <div v-if="currentView === 'browse'">
                <!-- Search Section -->
                <div class="solid-card mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="tabs">
                            <button @click="searchMode = 'text'" :class="['tab', { active: searchMode === 'text' }]">Text</button>
                            <button @click="searchMode = 'semantic'" :class="['tab', { active: searchMode === 'semantic' }]">Semantic</button>
                        </div>
                        <div class="flex-1 min-w-64">
                            <div class="search-bar">
                                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                                <input v-model="searchQuery" @keyup.enter="performSearch" type="text" class="input" :placeholder="searchMode === 'semantic' ? 'Describe what you\'re looking for...' : 'Search observations...'">
                            </div>
                        </div>
                        <button @click="performSearch" :disabled="searching" class="btn btn-primary">{{ searching ? 'Searching...' : 'Search' }}</button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex flex-wrap gap-3 mt-4">
                        <select v-model="filters.type" class="input input-sm" style="width: auto;">
                            <option value="">All Types</option>
                            <option v-for="t in types" :value="t">{{ t }}</option>
                        </select>
                        <select v-model="filters.importance" class="input input-sm" style="width: auto;">
                            <option value="">Any Importance</option>
                            <option value="0.9">90%+</option>
                            <option value="0.8">80%+</option>
                            <option value="0.6">60%+</option>
                        </select>
                        <select v-model="filters.entity" class="input input-sm" style="width: auto;">
                            <option value="">All Entities</option>
                            <option v-for="e in topEntities" :value="e.id">{{ e.name }} ({{ e.obs_count }})</option>
                        </select>
                        <label class="flex items-center gap-2 text-caption text-secondary cursor-pointer">
                            <input type="checkbox" v-model="filters.includeArchive" class="rounded">
                            Include Archive
                        </label>
                    </div>
                    
                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2 mt-4" v-if="tags.length">
                        <span v-for="tag in tags.slice(0, 20)" :key="tag.tag" @click="filters.tag = filters.tag === tag.tag ? '' : tag.tag" :class="['tag-pill', { active: filters.tag === tag.tag }]">
                            {{ tag.tag }} <span class="text-muted">{{ tag.count }}</span>
                        </span>
                    </div>
                </div>

                <!-- Results Info -->
                <div v-if="filters.date" class="flex items-center gap-3 mb-4">
                    <span class="badge badge-accent">Showing: {{ formatDate(filters.date) }}</span>
                    <button @click="clearDateFilter" class="btn btn-ghost btn-sm">‚úï Clear date filter</button>
                </div>
                <div v-else-if="searchMode === 'semantic' && semanticResults.length" class="text-caption text-brand mb-4">
                    Found {{ semanticResults.length }} relevant results (‚â•50% similarity)
                    <span v-if="semanticResults.length > 0" class="text-muted ml-2">
                        ‚Ä¢ Top match: {{ (semanticResults[0]?.similarity * 100).toFixed(0) }}%
                    </span>
                </div>
                <div v-else-if="searchMode === 'semantic' && searchQuery && !searching && semanticResults.length === 0" class="text-caption text-warning mb-4">
                    No results above 50% similarity threshold. Try different keywords.
                </div>

                <!-- Memory Cards - Bento Grid -->
                <div class="bento-grid">
                    <div v-for="obs in displayedObservations" :key="obs.id" class="memory-card relative" @click="selectObservation(obs)">
                        <!-- Importance indicator dot with tooltip -->
                        <div v-if="obs.importance > 0.8" class="importance-indicator" style="background: var(--color-warning)" data-tooltip="High Priority (80%+)"></div>
                        <div v-else-if="obs.importance > 0.5" class="importance-indicator" style="background: var(--brand-primary)" data-tooltip="Medium Priority (50%+)"></div>
                        
                        <!-- Entity/Title - Bold like Apple product names -->
                        <div class="flex items-center gap-2 mb-2">
                            <span v-if="obs.entity_name" class="text-body font-semibold text-primary">{{ obs.entity_name }}</span>
                            <span v-else class="text-body font-semibold text-primary">Memory</span>
                            <span v-if="obs.similarity" class="similarity-badge">{{ (obs.similarity * 100).toFixed(0) }}%</span>
                        </div>
                        
                        <!-- Preview text - muted like Apple descriptions -->
                        <div class="memory-text text-body-sm text-tertiary" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">{{ obs.observation_text }}</div>
                        
                        <!-- Footer: date and type -->
                        <div class="flex items-center justify-between mt-3 pt-3" style="border-top: 1px solid var(--glass-border);">
                            <span v-if="obs.observation_type" class="text-caption text-quaternary">{{ obs.observation_type }}</span>
                            <span v-else class="text-caption text-quaternary">note</span>
                            <span class="text-caption text-quaternary">{{ formatDate(obs.created_at) }}</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="!loading && displayedObservations.length === 0" class="empty-state">
                    <div class="empty-state-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <div class="empty-state-title">No memories found</div>
                    <div class="empty-state-desc">Try adjusting your search or filters</div>
                </div>

                <!-- Pagination (hidden in semantic mode - no server-side pagination for vector search) -->
                <div v-if="totalPages > 1 && searchMode !== 'semantic'" class="pagination mt-8">
                    <button @click="currentPage = 1" :disabled="currentPage === 1" class="page-btn" title="First">‚èÆ</button>
                    <button @click="currentPage--" :disabled="currentPage === 1" class="page-btn" title="Previous">‚óÄ</button>
                    <template v-for="page in visiblePages" :key="page">
                        <span v-if="page === '...'" class="text-muted px-2">...</span>
                        <button v-else @click="currentPage = page" :class="['page-btn', { active: currentPage === page }]">{{ page }}</button>
                    </template>
                    <button @click="currentPage++" :disabled="currentPage === totalPages" class="page-btn" title="Next">‚ñ∂</button>
                    <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="page-btn" title="Last">‚è≠</button>
                    <span class="ml-4 text-caption text-muted">{{ totalCount }} memories</span>
                </div>
            </div>


            <!-- TIMELINE VIEW -->
            <div v-if="currentView === 'timeline'">
                <div class="solid-card mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-headline">Memory Timeline</div>
                        <!-- Granularity Toggle -->
                        <div class="tabs">
                            <button @click="timelineGranularity = 'day'" :class="['tab', { active: timelineGranularity === 'day' }]">Day</button>
                            <button @click="timelineGranularity = 'week'" :class="['tab', { active: timelineGranularity === 'week' }]">Week</button>
                            <button @click="timelineGranularity = 'month'" :class="['tab', { active: timelineGranularity === 'month' }]">Month</button>
                        </div>
                    </div>
                    
                    <!-- Timeline Bars -->
                    <div class="timeline-container">
                        <div class="timeline-bars">
                            <div v-for="item in timeline" :key="item.period" 
                                 :class="['timeline-item', { 'timeline-item-selected': selectedPeriod === item.period }]" 
                                 @click="selectPeriod(item.period)" 
                                 :title="formatDate(item.period) + ': ' + item.count + ' memories'">
                                <div class="timeline-bar-total" :style="{ height: Math.max(4, (item.count / maxTimelineCount) * 120) + 'px' }"></div>
                                <div v-if="item.high_importance > 0" class="timeline-bar-important" :style="{ height: Math.max(2, item.high_importance * 4) + 'px' }"></div>
                                <div class="timeline-label">{{ formatShortDate(item.period) }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex items-center gap-6 mt-4 text-caption text-muted">
                        <span class="flex items-center gap-2">
                            <span style="width: 12px; height: 12px; background: var(--brand-primary); border-radius: 2px;"></span> Total
                        </span>
                        <span class="flex items-center gap-2">
                            <span style="width: 12px; height: 12px; background: var(--color-warning); border-radius: 2px;"></span> High Importance
                        </span>
                    </div>
                </div>
                
                <!-- Selected Period Results (inline) -->
                <div v-if="selectedPeriod" class="mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-subhead">{{ formatDate(selectedPeriod) }}</span>
                            <span class="badge badge-accent">{{ timelineObservations.length }} memories</span>
                        </div>
                        <button @click="selectedPeriod = null" class="btn btn-ghost btn-sm">‚úï Clear selection</button>
                    </div>
                    
                    <div v-if="timelineLoading" class="text-center py-8 text-muted">Loading...</div>
                    
                    <div v-else-if="timelineObservations.length === 0" class="empty-state py-8">
                        <div class="text-tertiary">No memories for this date</div>
                    </div>
                    
                    <div v-else class="bento-grid">
                        <div v-for="obs in timelineObservations" :key="obs.id" class="memory-card relative" @click="selectObservation(obs)">
                            <!-- Importance indicator dot with tooltip -->
                            <div v-if="obs.importance > 0.8" class="importance-indicator" style="background: var(--color-warning)" data-tooltip="High Priority (80%+)"></div>
                            <div v-else-if="obs.importance > 0.5" class="importance-indicator" style="background: var(--brand-primary)" data-tooltip="Medium Priority (50%+)"></div>
                            
                            <!-- Entity/Title - Bold like Apple product names -->
                            <div class="flex items-center gap-2 mb-2">
                                <span v-if="obs.entity_name" class="text-body font-semibold text-primary">{{ obs.entity_name }}</span>
                                <span v-else class="text-body font-semibold text-primary">Memory</span>
                            </div>
                            
                            <!-- Preview text - muted like Apple descriptions -->
                            <div class="memory-text text-body-sm text-tertiary" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">{{ obs.observation_text }}</div>
                            
                            <!-- Footer: date and type -->
                            <div class="flex items-center justify-between mt-3 pt-3" style="border-top: 1px solid var(--glass-border);">
                                <span v-if="obs.observation_type" class="text-caption text-quaternary">{{ obs.observation_type }}</span>
                                <span v-else class="text-caption text-quaternary">note</span>
                                <span class="text-caption text-quaternary">{{ formatDate(obs.created_at) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Prompt to select a day -->
                <div v-else class="text-center py-12 text-muted">
                    <div class="text-lg mb-2">üëÜ</div>
                    <div>Click a day above to view its memories</div>
                </div>
            </div>

            <!-- INSIGHTS VIEW -->
            <div v-if="currentView === 'insights'">
                <!-- Bento Layout -->
                <div class="insights-bento">
                    
                    <!-- Activity Pattern - Full width hero -->
                    <div class="insight-card insight-hero" v-if="insights.find(i => i.type === 'activity_pattern')">
                        <div class="text-caption text-quaternary uppercase tracking-wide mb-2">Weekly Activity</div>
                        <div class="text-title mb-6">When You Capture Memories</div>
                        <div class="activity-chart">
                            <div v-for="item in insights.find(i => i.type === 'activity_pattern')?.data" :key="item.day" class="activity-day">
                                <div class="activity-bar-wrapper">
                                    <div class="activity-bar-fill" :style="{ height: (item.count / maxDayActivity * 100) + '%' }"></div>
                                </div>
                                <div class="activity-day-label">{{ item.day.slice(0, 3) }}</div>
                                <div class="activity-day-count">{{ item.count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Focus Areas - Large card -->
                    <div class="insight-card insight-large" v-if="insights.find(i => i.type === 'focus_areas')">
                        <div class="text-caption text-quaternary uppercase tracking-wide mb-2">Top Focus Areas</div>
                        <div class="text-headline mb-5">Last 30 Days</div>
                        <div class="focus-list">
                            <div v-for="(item, i) in insights.find(i => i.type === 'focus_areas')?.data" :key="item.tag" class="focus-item" @click="filters.tag = item.tag; currentView = 'browse'">
                                <div class="focus-rank">{{ i + 1 }}</div>
                                <div class="focus-info">
                                    <div class="focus-tag">{{ item.tag }}</div>
                                    <div class="focus-bar">
                                        <div class="focus-bar-fill" :style="{ width: (item.count / insights.find(i => i.type === 'focus_areas')?.data[0].count * 100) + '%' }"></div>
                                    </div>
                                </div>
                                <div class="focus-count">{{ item.count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tag Correlations -->
                    <div class="insight-card" v-if="insights.find(i => i.type === 'tag_correlation')">
                        <div class="text-caption text-quaternary uppercase tracking-wide mb-2">Connections</div>
                        <div class="text-headline mb-5">Frequently Co-occurring</div>
                        <div class="correlation-list">
                            <div v-for="item in insights.find(i => i.type === 'tag_correlation')?.data" :key="item.tag1 + item.tag2" class="correlation-item">
                                <div class="correlation-tags">
                                    <span class="correlation-tag" @click="filters.tag = item.tag1; currentView = 'browse'">{{ item.tag1 }}</span>
                                    <span class="correlation-arrow">‚Üî</span>
                                    <span class="correlation-tag" @click="filters.tag = item.tag2; currentView = 'browse'">{{ item.tag2 }}</span>
                                </div>
                                <div class="correlation-count">{{ item.co_count }}√ó</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones -->
                    <div class="insight-card" v-if="insights.find(i => i.type === 'milestones')">
                        <div class="text-caption text-quaternary uppercase tracking-wide mb-2">Highlights</div>
                        <div class="text-headline mb-5">Recent Milestones</div>
                        <div class="milestone-list">
                            <div v-for="item in insights.find(i => i.type === 'milestones')?.data" :key="item.id" class="milestone-row" @click="openMilestone(item)">
                                <div class="milestone-date">{{ formatDate(item.created_at) }}</div>
                                <div class="milestone-text">{{ item.preview }}</div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- ARCHIVE VIEW -->
            <div v-if="currentView === 'archive'">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-title">Archived Memories</h2>
                        <p class="text-secondary text-sm mt-1">{{ archiveTotal.toLocaleString() }} archived observations</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="text" v-model="archiveSearch" @input="fetchArchive" placeholder="Search archive..." class="input input-sm" style="width: 200px;">
                    </div>
                </div>
                
                <div v-if="archiveLoading" class="text-center py-12 text-secondary">Loading archive...</div>
                
                <div v-else class="bento-grid">
                    <div v-for="obs in archiveObservations" :key="obs.id" class="memory-card relative" @click="selectObservation(obs)">
                        <!-- Entity/Title -->
                        <div class="flex items-center gap-2 mb-2">
                            <span v-if="obs.entity_name" class="text-body font-semibold text-primary">{{ obs.entity_name }}</span>
                            <span v-else class="text-body font-semibold text-primary">Memory</span>
                            <span class="badge badge-glass" style="opacity: 0.5; font-size: 10px;">archived</span>
                        </div>
                        
                        <!-- Preview text -->
                        <div class="memory-text text-body-sm text-tertiary" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">{{ obs.observation_text }}</div>
                        
                        <!-- Footer -->
                        <div class="flex items-center justify-between mt-3 pt-3" style="border-top: 1px solid var(--glass-border);">
                            <span v-if="obs.observation_type" class="text-caption text-quaternary">{{ obs.observation_type }}</span>
                            <span v-else class="text-caption text-quaternary">note</span>
                            <span class="text-caption text-quaternary">{{ formatDate(obs.created_at) }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div v-if="!archiveLoading && archiveObservations.length === 0" class="empty-state">
                    <div class="empty-state-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <div class="empty-state-title">No archived memories found</div>
                    <div class="empty-state-desc">Try adjusting your search</div>
                </div>
                
                <!-- Pagination -->
                <div v-if="archivePages > 1" class="pagination mt-6">
                    <button @click="archivePage = 1; fetchArchive()" :disabled="archivePage === 1" class="page-btn" title="First">‚èÆ</button>
                    <button @click="archivePage--; fetchArchive()" :disabled="archivePage === 1" class="page-btn" title="Previous">‚óÄ</button>
                    <template v-for="page in visibleArchivePages" :key="'arch-'+page">
                        <span v-if="page === '...'" class="text-muted px-2">...</span>
                        <button v-else @click="archivePage = page; fetchArchive()" :class="['page-btn', { active: archivePage === page }]">{{ page }}</button>
                    </template>
                    <button @click="archivePage++; fetchArchive()" :disabled="archivePage === archivePages" class="page-btn" title="Next">‚ñ∂</button>
                    <button @click="archivePage = archivePages; fetchArchive()" :disabled="archivePage === archivePages" class="page-btn" title="Last">‚è≠</button>
                    <span class="ml-4 text-caption text-muted">{{ archiveTotal }} archived</span>
                </div>
            </div>

        </main>
    </div>


<script>
const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

createApp({
    setup() {
        // Theme
        const theme = ref(localStorage.getItem('theme') || 'system');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        const systemDark = ref(prefersDark.matches);
        
        // Listen for system theme changes
        prefersDark.addEventListener('change', (e) => {
            systemDark.value = e.matches;
        });
        
        const isDark = computed(() => {
            if (theme.value === 'dark') return true;
            if (theme.value === 'light') return false;
            return systemDark.value;
        });
        const setTheme = (t) => { theme.value = t; localStorage.setItem('theme', t); };
        
        watch(isDark, (dark) => {
            if (dark) {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            }
        }, { immediate: true });

        // Scroll detection for nav
        const isScrolled = ref(false);
        window.addEventListener('scroll', () => { isScrolled.value = window.scrollY > 20; });

        // Data
        const stats = ref({});
        const observations = ref([]);
        const semanticResults = ref([]);
        const entities = ref([]);
        const tags = ref([]);
        const timeline = ref([]);
        const insights = ref([]);
        const loading = ref(false);
        
        // Archive state
        const archiveObservations = ref([]);
        const archiveLoading = ref(false);
        const archivePage = ref(1);
        const archivePages = ref(1);
        const archiveTotal = ref(0);
        const archiveSearch = ref('');
        
        // UI State
        const currentView = ref('browse');
        const searchMode = ref('text');
        const searchQuery = ref('');
        const searching = ref(false);
        const selectedObservation = ref(null);
        const timelineGranularity = ref('day');
        const currentPage = ref(1);
        const totalPages = ref(1);
        const totalCount = ref(0);
        const selectedPeriod = ref(null);
        const timelineObservations = ref([]);
        const timelineLoading = ref(false);
        
        // Filters
        const filters = ref({ type: '', importance: '', entity: '', tag: '', date: '', includeArchive: false });
        
        // Error state
        const errorMessage = ref('');
        
        // Command Palette
        const showCommandPalette = ref(false);
        const cmdQuery = ref('');
        const cmdIndex = ref(0);
        const cmdLoading = ref(false);
        const cmdInput = ref(null);
        const cmdResults = ref([]);
        
        const defaultCommands = [
            { id: 'search', icon: 'üîç', name: 'Text Search', description: 'Full-text search', action: () => { searchMode.value = 'text'; showCommandPalette.value = false; }},
            { id: 'semantic', icon: 'üß†', name: 'Semantic Search', description: 'Find by meaning', action: () => { searchMode.value = 'semantic'; showCommandPalette.value = false; }},
            { id: 'graph', icon: 'üï∏Ô∏è', name: 'Knowledge Graph', description: 'Visual exploration', action: () => { window.location.href = '/graph'; }},
            { id: 'timeline', icon: 'üìÖ', name: 'Timeline View', description: 'Browse by date', action: () => { currentView.value = 'timeline'; showCommandPalette.value = false; }},
            { id: 'insights', icon: 'üí°', name: 'Insights', description: 'Patterns & analytics', action: () => { currentView.value = 'insights'; showCommandPalette.value = false; }},
        ];
        
        const filteredCommands = computed(() => cmdQuery.value ? cmdResults.value : defaultCommands);
        
        // Computed
        const embeddingPercent = computed(() => stats.value.observations ? Math.round((stats.value.embedded / stats.value.observations) * 100) : 0);
        const topEntities = computed(() => entities.value.slice(0, 20));
        const types = computed(() => stats.value.by_type?.map(t => t.observation_type) || []);
        const displayedObservations = computed(() => searchMode.value === 'semantic' && semanticResults.value.length > 0 ? semanticResults.value : observations.value);
        const maxTimelineCount = computed(() => Math.max(...timeline.value.map(d => d.count), 1));
        const maxDayActivity = computed(() => {
            const activityInsight = insights.value.find(i => i.type === 'activity_pattern');
            return activityInsight ? Math.max(...activityInsight.data.map(d => d.count)) : 1;
        });
        
        const visiblePages = computed(() => {
            const current = currentPage.value, total = totalPages.value, pages = [];
            if (total <= 7) { for (let i = 1; i <= total; i++) pages.push(i); }
            else {
                pages.push(1);
                if (current > 4) pages.push('...');
                for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
                if (current < total - 3) pages.push('...');
                pages.push(total);
            }
            return pages;
        });
        
        const visibleArchivePages = computed(() => {
            const current = archivePage.value, total = archivePages.value, pages = [];
            if (total <= 7) { for (let i = 1; i <= total; i++) pages.push(i); }
            else {
                pages.push(1);
                if (current > 4) pages.push('...');
                for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
                if (current < total - 3) pages.push('...');
                pages.push(total);
            }
            return pages;
        });

        // Methods
        const fetchStats = async () => {
            try {
                stats.value = await (await fetch('/api/stats')).json();
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        };
        
        const fetchObservations = async () => {
            loading.value = true;
            errorMessage.value = '';
            try {
                const params = new URLSearchParams({
                    page: currentPage.value, per_page: 30, search: searchQuery.value,
                    type: filters.value.type, min_importance: filters.value.importance,
                    entity_id: filters.value.entity, tag: filters.value.tag, 
                    date: filters.value.date, include_archive: filters.value.includeArchive
                });
                const response = await fetch(`/api/observations?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                observations.value = data.observations;
                totalPages.value = data.pages;
                totalCount.value = data.total;
            } catch (e) {
                console.error('Failed to fetch observations:', e);
                errorMessage.value = 'Failed to load memories. Is the dashboard server running?';
            } finally {
                loading.value = false;
            }
        };
        
        const fetchEntities = async () => {
            try {
                entities.value = (await (await fetch('/api/entities')).json()).entities;
            } catch (e) {
                console.error('Failed to fetch entities:', e);
            }
        };
        
        const fetchTags = async () => {
            try {
                tags.value = (await (await fetch('/api/tags')).json()).tags;
            } catch (e) {
                console.error('Failed to fetch tags:', e);
            }
        };
        
        const fetchTimeline = async () => {
            try {
                timeline.value = ((await (await fetch(`/api/timeline?granularity=${timelineGranularity.value}`)).json()).timeline || []).reverse();
            } catch (e) {
                console.error('Failed to fetch timeline:', e);
            }
        };
        
        const fetchInsights = async () => {
            try {
                insights.value = (await (await fetch('/api/insights')).json()).insights || [];
            } catch (e) {
                console.error('Failed to fetch insights:', e);
            }
        };
        
        const fetchArchive = async () => {
            archiveLoading.value = true;
            const params = new URLSearchParams({
                page: archivePage.value,
                per_page: 50,
                search: archiveSearch.value
            });
            const data = await (await fetch(`/api/archive?${params}`)).json();
            archiveObservations.value = data.observations;
            archivePages.value = data.pages;
            archiveTotal.value = data.total;
            archiveLoading.value = false;
        };
        
        const performSearch = async () => {
            if (searchMode.value === 'semantic') {
                if (!searchQuery.value.trim()) return;
                searching.value = true;
                try {
                    const data = await (await fetch(`/api/search/semantic?q=${encodeURIComponent(searchQuery.value)}&limit=30&include_archive=${filters.value.includeArchive}`)).json();
                    semanticResults.value = data.results || [];
                } catch (e) { console.error('Semantic search failed:', e); }
                searching.value = false;
            } else {
                semanticResults.value = [];
                currentPage.value = 1;
                await fetchObservations();
            }
        };
        
        const findSimilar = async (obsId) => {
            searching.value = true;
            searchMode.value = 'semantic';
            try {
                const data = await (await fetch(`/api/search/similar/${obsId}?limit=20`)).json();
                semanticResults.value = data.results || [];
                selectedObservation.value = null;
                searchQuery.value = `Similar to #${obsId}`;
            } catch (e) { console.error('Find similar failed:', e); }
            searching.value = false;
        };
        
        const deleteObservation = async (obsId) => {
            if (!confirm('Are you sure you want to delete this memory? This cannot be undone.')) return;
            
            try {
                const res = await fetch(`/api/observation/${obsId}`, { method: 'DELETE' });
                if (res.ok) {
                    selectedObservation.value = null;
                    // Remove from current results
                    observations.value = observations.value.filter(o => o.id !== obsId);
                    semanticResults.value = semanticResults.value.filter(o => o.id !== obsId);
                    archiveObservations.value = archiveObservations.value.filter(o => o.id !== obsId);
                    // Refresh stats
                    fetchStats();
                    if (currentView.value === 'archive') {
                        fetchArchive();
                    } else {
                        fetchObservations();
                    }
                } else {
                    alert('Failed to delete memory');
                }
            } catch (e) {
                console.error('Delete failed:', e);
                alert('Failed to delete memory');
            }
        };
        
        const selectObservation = (obs) => { selectedObservation.value = obs; };
        
        const filterByPeriod = (period) => {
            currentView.value = 'browse';
            searchMode.value = 'text';
            semanticResults.value = [];
            searchQuery.value = '';
            filters.value.date = period;  // Set the date filter (YYYY-MM-DD)
            currentPage.value = 1;
            fetchObservations();
        };
        
        const selectPeriod = async (period) => {
            // Toggle off if clicking same period
            if (selectedPeriod.value === period) {
                selectedPeriod.value = null;
                timelineObservations.value = [];
                return;
            }
            
            selectedPeriod.value = period;
            timelineLoading.value = true;
            
            try {
                const params = new URLSearchParams({ date: period, per_page: 50 });
                const data = await (await fetch(`/api/observations?${params}`)).json();
                timelineObservations.value = data.observations || [];
            } catch (e) {
                console.error('Failed to load period observations:', e);
                timelineObservations.value = [];
            }
            
            timelineLoading.value = false;
        };
        
        const clearDateFilter = () => {
            filters.value.date = '';
            fetchObservations();
        };
        
        const openMilestone = async (item) => {
            // Fetch the full observation by ID
            try {
                const data = await (await fetch(`/api/observation/${item.id}`)).json();
                if (data.observation) {
                    selectedObservation.value = data.observation;
                }
            } catch (e) {
                console.error('Failed to load milestone:', e);
            }
        };
        
        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };
        
        const formatShortDate = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };
        
        const openCommandPalette = () => {
            showCommandPalette.value = true;
            cmdQuery.value = '';
            cmdIndex.value = 0;
            cmdResults.value = [];
            nextTick(() => cmdInput.value?.focus());
        };
        
        const executeCommand = (cmd) => {
            const command = cmd || filteredCommands.value[cmdIndex.value];
            if (command?.action) command.action();
            else if (command?.type === 'observation') { selectObservation(command); showCommandPalette.value = false; }
        };
        
        // Debounced command palette search
        let cmdSearchTimeout;
        watch(cmdQuery, (q) => {
            clearTimeout(cmdSearchTimeout);
            if (q.length < 2) { cmdResults.value = []; return; }
            cmdLoading.value = true;
            cmdSearchTimeout = setTimeout(async () => {
                try {
                    const data = await (await fetch(`/api/search/semantic?q=${encodeURIComponent(q)}&limit=10`)).json();
                    cmdResults.value = (data.results || []).map(r => ({
                        ...r, id: `obs-${r.id}`, type: 'observation', icon: 'üìù',
                        name: r.observation_text?.slice(0, 60) + '...', description: r.entity_name || 'Observation'
                    }));
                } catch (e) {}
                cmdLoading.value = false;
            }, 300);
        });
        
        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCommandPalette(); }
            if (e.key === 'Escape' && selectedObservation.value) { selectedObservation.value = null; }
        });
        
        // Watchers with debounce to prevent API flooding
        let fetchTimeout;
        watch([filters, currentPage], () => {
            if (searchMode.value === 'text') {
                clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(() => fetchObservations(), 250);
            }
        }, { deep: true });
        watch(timelineGranularity, () => {
            selectedPeriod.value = null;
            timelineObservations.value = [];
            fetchTimeline();
        });
        watch(currentView, (v) => {
            if (v === 'timeline') fetchTimeline();
            if (v === 'insights') fetchInsights();
            if (v === 'archive') fetchArchive();
        });

        // Init
        onMounted(async () => {
            // Check URL params for view
            const params = new URLSearchParams(window.location.search);
            const viewParam = params.get('view');
            if (viewParam && ['browse', 'timeline', 'insights', 'archive'].includes(viewParam)) {
                currentView.value = viewParam;
            }
            const searchParam = params.get('search');
            if (searchParam) searchQuery.value = searchParam;
            const entityParam = params.get('entity_id');
            if (entityParam) filters.value.entity = entityParam;
            await Promise.all([fetchStats(), fetchObservations(), fetchEntities(), fetchTags()]);
        });

        return {
            theme, isDark, setTheme, isScrolled,
            stats, observations, semanticResults, entities, tags, timeline, insights, loading, errorMessage,
            archiveObservations, archiveLoading, archivePage, archivePages, archiveTotal, archiveSearch, fetchArchive,
            currentView, searchMode, searchQuery, searching, selectedObservation, timelineGranularity,
            currentPage, totalPages, totalCount, filters,
            selectedPeriod, timelineObservations, timelineLoading,
            showCommandPalette, cmdQuery, cmdIndex, cmdLoading, cmdInput, cmdResults,
            defaultCommands, filteredCommands,
            embeddingPercent, topEntities, types, displayedObservations, maxTimelineCount, maxDayActivity, visiblePages, visibleArchivePages,
            performSearch, findSimilar, deleteObservation, selectObservation, filterByPeriod, selectPeriod, clearDateFilter, openMilestone,
            formatDate, formatShortDate, openCommandPalette, executeCommand
        };
    }
}).mount('#app');
</script>
</body>
</html>
